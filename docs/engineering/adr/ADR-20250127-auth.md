# ADR-20250127: 認証方式選択

## ステータス
✅ **採用済み** (2025-01-27)

## 文脈（Context）
簿記3級問題集アプリにおいて、ユーザー認証・識別の方式を決定する必要がある。

### アプリの特徴
- **買い切り型アプリ**: 月額課金・継続的なサーバー接続不要
- **プライバシー重視**: 個人情報の非収集を強く訴求
- **ローカル完結**: 全データを端末内で管理
- **シンプル設計**: 複雑性を最小化し、保守性を重視

### データの性質
- **学習履歴**: 個人に紐づくが、外部送信・共有不要（CBT解答データ含む）
- **進捗データ**: 端末内での管理で十分
- **設定データ**: デバイス固有・個人識別不要
- **CBT解答データ**: プルダウン選択・数値入力の履歴（JSON形式、匿名化済み）

## 選択肢（Options）

### 選択肢1: 認証なし（完全匿名）
**メリット**:
- プライバシー保護の完全実現
- 実装コスト・複雑性ゼロ
- ユーザー体験の最大化（登録・ログイン不要）
- サーバーインフラ不要

**デメリット**:
- 複数端末でのデータ共有不可
- データ復旧がローカルバックアップに依存
- 将来的な機能拡張（ソーシャル機能等）への制約

### 選択肢2: 匿名認証（Firebase Anonymous Auth）
**メリット**:
- 個人情報収集なし
- 端末間でのデータ同期可能
- 必要時にアップグレード可能

**デメリット**:
- Firebase依存（サーバーインフラ必要）
- オフライン完全対応の複雑化
- 匿名IDの管理・復旧リスク

### 選択肢3: 軽量認証（PIN・パスワード）
**メリット**:
- 簡単な本人確認
- データ保護機能
- サーバー不要

**デメリット**:
- ユーザビリティ低下
- パスワード忘れのサポート負荷
- 本質的な価値提供と無関係

### 選択肢4: ソーシャル認証（Google・Apple）
**メリット**:
- 標準的な認証フロー
- 複数端末同期・データ復旧

**デメリット**:
- **プライバシー方針と矛盾**
- サーバーインフラ必要
- 個人情報取得への懸念
- 実装・保守コスト高

## 決定（Decision）
**認証なし（完全匿名）** を採用する。

### 採用理由
1. **プライバシー第一**: 個人情報非収集の方針と完全整合
2. **ユーザー体験**: 登録・ログインなしで即座に学習開始可能
3. **シンプル設計**: 認証関連の複雑性・バグリスク排除
4. **コスト最適化**: サーバーインフラ・保守コスト不要
5. **要件適合**: 現在の機能要件で認証は不要

### 設計方針
```typescript
// ユーザー識別は端末内のみで実施
interface LocalUserIdentity {
  // 端末内での一意ID（UUID生成）
  deviceUserId: string
  
  // 初回起動時の作成日時
  createdAt: string
  
  // 個人情報は一切含まない
  // personalInfo: never
}

// データは全て端末ローカルに保存
class LocalDataManager {
  // 匿名化された学習データのみ扱う
  async saveProgress(progress: AnonymousProgress): Promise<void>
  async loadProgress(): Promise<AnonymousProgress>
  
  // 外部送信機能は実装しない
  // async syncToServer(): never
}
```

## 影響範囲（Consequences）

### ポジティブな影響
- ✅ **プライバシー保護**: 個人情報収集ゼロの実現
- ✅ **ユーザー体験**: 即座に学習開始、登録ストレス除去
- ✅ **開発効率**: 認証関連の実装・テスト・保守不要
- ✅ **運用コスト**: サーバー運用・セキュリティ対策不要
- ✅ **法的リスク**: 個人情報漏洩・GDPR等への対応不要

### ネガティブな影響
- ❌ **データ共有**: 複数端末間でのデータ同期不可
- ❌ **データ復旧**: 端末紛失時の学習履歴復旧困難
- ❌ **機能制限**: ソーシャル機能・ランキング等の実装困難
- ❌ **分析制限**: ユーザー行動の縦断的分析不可

### リスク軽減策
1. **データ消失リスク**:
   - ローカルバックアップ・エクスポート機能
   - 分かりやすいデータ管理ガイド提供

2. **複数端末利用の要望**:
   - QRコード等でのデータ移行機能
   - 将来的にオプトイン型認証の検討

3. **分析データ不足**:
   - 完全匿名化された集計データの収集
   - アプリ内フィードバック機能での補完

## 代替案（Alternatives）
将来的な見直し条件：

### 条件1: 複数端末同期への強い要望
- **トリガー**: ユーザーの50%以上から複数端末対応要望
- **対応**: オプトイン型の匿名認証導入検討
- **実装**: Firebase Anonymous Authでの最小限同期

### 条件2: ソーシャル機能の必要性
- **トリガー**: 競合優位性確保のため必要と判断
- **対応**: プライバシー保護型のソーシャル機能検討
- **実装**: ハッシュ化された匿名IDでの限定的連携

### 条件3: 法的要件の変化
- **トリガー**: 規制変更で認証が必須となった場合
- **対応**: 最小限の認証機能実装
- **実装**: PIN認証等のローカル完結型

## 関連決定
- [ADR-20250127-db-choice](./ADR-20250127-db-choice.md): SQLite選択による完全ローカル化
- 将来のADR: データ同期・ソーシャル機能検討時

## 実装ガイドライン

### 1. 匿名化データ設計
```typescript
// 個人を特定できない学習データ
interface AnonymousLearningData {
  // 端末内でのみ有効なID
  sessionId: string
  
  // 学習統計（個人識別情報なし）
  progress: {
    totalQuestions: number
    correctAnswers: number
    averageTime: number
    categoryProgress: Record<string, number>
  }
  
  // 時系列データ（日付のみ、時刻なし）
  dailyStats: Array<{
    date: string  // YYYY-MM-DD形式
    questionsAnswered: number
    accuracy: number
  }>
  
  // 禁止フィールド（コンパイルエラーで防止）
  // userId: never
  // email: never
  // deviceIdentifier: never
}
```

### 2. プライバシー保護機能
```typescript
// データ完全削除機能
class PrivacyManager {
  async deleteAllUserData(): Promise<void> {
    // SQLiteデータベース完全削除
    await this.database.dropAllTables()
    
    // ローカルファイル削除
    await this.storage.clearAllFiles()
    
    // キャッシュクリア
    await this.cache.clearAll()
  }
  
  async exportAnonymousData(): Promise<AnonymousDataExport> {
    // 個人識別情報を除外したデータエクスポート
    return {
      learningProgress: await this.getLearningProgress(),
      settings: await this.getAppSettings(),
      // 個人識別情報は含めない
    }
  }
}
```

### 3. 透明性確保
```typescript
// データ収集の透明性
class TransparencyService {
  // 何のデータを何のために使用しているかを明示
  getDataUsageDescription(): DataUsageInfo {
    return {
      collected: [
        {
          type: 'learning_progress',
          purpose: 'Show your study progress',
          storage: 'Local device only',
          sharing: 'Never shared'
        }
      ],
      notCollected: [
        'Personal identification information',
        'Contact information', 
        'Device identifiers',
        'Location data'
      ]
    }
  }
}
```

### 4. 将来拡張への配慮
```typescript
// 将来の認証導入に備えた抽象化
interface AuthService {
  // 現在は常に匿名ユーザーを返す
  getCurrentUser(): Promise<AnonymousUser>
  
  // 将来的にオプトイン認証を追加時に拡張
  // login(credentials: Credentials): Promise<User>
}

class AnonymousAuthService implements AuthService {
  async getCurrentUser(): Promise<AnonymousUser> {
    return {
      id: await this.getOrCreateDeviceUserId(),
      isAnonymous: true
    }
  }
}
```

---

**この決定は、ユーザーのプライバシー保護を最優先とし、シンプルで安全なアプリ体験の提供を目指しています。将来的な機能要望に応じて、プライバシー保護を前提とした最小限の拡張を検討します。**