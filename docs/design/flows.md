# ユーザーフロー設計

## 1. メインフロー概要

### 1.1 学習フロー（通常学習）
```mermaid
flowchart TD
    A[アプリ起動] --> B[ホーム画面]
    B --> C[学習開始をタップ]
    C --> D[分野選択<br/>仕訳・帳簿・試算表]
    D --> E[問題表示]
    E --> F[選択肢をタップ]
    F --> G[解答ボタンをタップ]
    G --> H[正誤判定表示]
    H --> I[解説表示]
    I --> J{続ける？}
    J -->|はい| K[次の問題]
    J -->|いいえ| L[学習終了]
    K --> E
    L --> M[学習結果保存]
    M --> B
```

### 1.2 復習フロー（弱点克服）
```mermaid
flowchart TD
    A[ホーム画面] --> B[復習モードをタップ]
    B --> C[復習リスト表示<br/>優先度順]
    C --> D{復習方法選択}
    D -->|全て| E[最優先問題から開始]
    D -->|分野別| F[分野選択]
    F --> G[分野別復習問題表示]
    E --> H[復習問題解答]
    G --> H
    H --> I[解答確認・解説]
    I --> J{正解？}
    J -->|正解| K[復習リストから除外判定]
    J -->|不正解| L[優先度再計算]
    K --> M{連続2回正解？}
    M -->|はい| N[克服済みに変更]
    M -->|いいえ| O[次の復習問題]
    L --> O
    N --> O
    O --> P{復習継続？}
    P -->|はい| H
    P -->|いいえ| Q[復習結果表示]
    Q --> R[ホーム画面に戻る]
```

### 1.3 模試フロー（実力測定・新コンテンツ構成対応）
```mermaid
flowchart TD
    A[ホーム画面] --> B[模試をタップ]
    B --> C[模試選択画面<br/>5セットから選択]
    C --> D[模試説明画面<br/>60分・18問・70点合格]
    D --> E[開始ボタンをタップ]
    E --> F[タイマー開始<br/>60分カウントダウン]
    F --> G[第1問: 仕訳15問<br/>推奨時間30分]
    G --> H[第2問: 帳簿2問<br/>推奨時間15分]
    H --> I[第3問: 試算表1問<br/>推奨時間15分]
    I --> J[全問解答完了？]
    J -->|未完了| K[見直し画面<br/>問題一覧・未回答表示]
    K --> L{操作選択}
    L -->|問題選択| M[特定問題に移動]
    L -->|提出| N[確認ダイアログ<br/>未回答問題警告]
    M --> G
    J -->|完了| N
    N --> O[採点・結果表示<br/>分野別得点表示]
    O --> P[合格判定<br/>70点以上/未満]
    P --> Q[詳細分析画面<br/>時間配分・分野別正答率]
    Q --> R[間違い問題の<br/>復習リスト追加]
    R --> S[他の模試セット推奨表示]
    S --> T[ホーム画面に戻る]
```

## 2. 詳細フロー設計

### 2.1 アプリ起動・初期化フロー
```mermaid
flowchart TD
    A[アプリアイコンタップ] --> B[スプラッシュ画面<br/>2-3秒]
    B --> C[ローカルデータ確認]
    C --> D{初回起動？}
    D -->|はい| E[オンボーディング画面]
    E --> F[アプリの使い方説明]
    F --> G[データ保存の説明]
    G --> H[アクセシビリティ設定]
    H --> I[ホーム画面表示]
    D -->|いいえ| J[学習データ読み込み]
    J --> K[前回の学習状態復元]
    K --> I
    I --> L[今日の学習目標表示]
```

### 2.2 問題解答詳細フロー
```mermaid
flowchart TD
    A[問題画面表示] --> B[問題文読み込み<br/>2秒以内]
    B --> C[選択肢表示<br/>A, B, C, D]
    C --> D[ユーザー選択待ち]
    D --> E[選択肢をタップ]
    E --> F[選択状態ハイライト]
    F --> G[解答ボタン活性化]
    G --> H[解答ボタンタップ]
    H --> I[解答データ保存]
    I --> J[正誤判定<br/>1秒以内]
    J --> K{正解？}
    K -->|正解| L[正解アニメーション<br/>緑色表示]
    K -->|不正解| M[不正解アニメーション<br/>赤色表示]
    L --> N[解説画面表示]
    M --> O[正解選択肢ハイライト]
    O --> N
    N --> P[関連問題リンク表示]
    P --> Q[次へボタン表示]
```

### 2.3 復習優先度計算フロー
```mermaid
flowchart TD
    A[問題解答完了] --> B[解答結果確認]
    B --> C{正解？}
    C -->|正解| D[問題状態確認]
    D --> E{前回の状態}
    E -->|要復習| F[連続正解カウント+1]
    E -->|重点復習| G[連続正解カウント+1]
    E -->|正解済み| H[状態維持]
    F --> I{連続2回正解？}
    G --> I
    I -->|はい| J[克服済みに変更]
    I -->|いいえ| K[状態維持]
    C -->|不正解| L[誤答回数+1]
    L --> M[最終誤答日更新]
    M --> N{誤答回数判定}
    N -->|1回| O[要復習に変更]
    N -->|2回以上| P[重点復習に変更]
    O --> Q[優先度計算]
    P --> Q
    Q --> R[復習リスト更新]
```

### 2.4 データ同期・保存フロー
```mermaid
flowchart TD
    A[データ変更発生] --> B[ローカルDB更新]
    B --> C[更新時刻記録]
    C --> D[自動保存完了]
    D --> E{バックアップ設定}
    E -->|有効| F[バックアップデータ作成]
    E -->|無効| G[処理完了]
    F --> H[暗号化処理]
    H --> I[ローカルファイル保存]
    I --> G
```

## 3. エラーハンドリングフロー

### 3.1 アプリクラッシュ・復旧フロー
```mermaid
flowchart TD
    A[アプリクラッシュ発生] --> B[次回起動時]
    B --> C[異常終了検出]
    C --> D[データ整合性チェック]
    D --> E{データ正常？}
    E -->|はい| F[前回状態復元]
    E -->|いいえ| G[データ復旧処理]
    G --> H[バックアップからの復元]
    H --> I{復元成功？}
    I -->|はい| J[復元完了通知]
    I -->|いいえ| K[初期化提案ダイアログ]
    K --> L[ユーザー選択待ち]
    F --> M[ホーム画面表示]
    J --> M
```

### 3.2 データ不整合エラーフロー
```mermaid
flowchart TD
    A[データ読み込み] --> B[整合性チェック]
    B --> C{整合性OK？}
    C -->|OK| D[正常処理継続]
    C -->|NG| E[エラーダイアログ表示]
    E --> F[修復オプション提示]
    F --> G{ユーザー選択}
    G -->|修復| H[自動修復処理]
    G -->|初期化| I[データ初期化確認]
    G -->|キャンセル| J[最小限機能で継続]
    H --> K{修復成功？}
    K -->|成功| L[修復完了通知]
    K -->|失敗| M[初期化推奨ダイアログ]
    I --> N[全データ削除・初期化]
    N --> O[初回セットアップ開始]
```

## 4. 特殊条件下のフロー

### 4.1 オフライン利用フロー
```mermaid
flowchart TD
    A[機能実行要求] --> B[ネットワーク状態確認]
    B --> C{オンライン？}
    C -->|オンライン| D[通常処理実行]
    C -->|オフライン| E[ローカルデータ確認]
    E --> F{必要データ存在？}
    F -->|存在| G[オフライン処理実行]
    F -->|不存在| H[オフライン制限通知]
    G --> I[処理結果をローカル保存]
    I --> J[次回オンライン時の同期予約]
    H --> K[代替操作提案]
```

### 4.2 アクセシビリティ対応フロー
```mermaid
flowchart TD
    A[画面表示要求] --> B[アクセシビリティ設定確認]
    B --> C{設定内容}
    C -->|大きな文字| D[フォントサイズ拡大]
    C -->|高コントラスト| E[色彩設定変更]
    C -->|音声読み上げ| F[音声対応属性設定]
    D --> G[レイアウト再計算]
    E --> H[色彩値変更]
    F --> I[aria-label設定]
    G --> J[画面描画]
    H --> J
    I --> J
    J --> K[アクセシビリティ検証]
    K --> L{検証合格？}
    L -->|合格| M[表示完了]
    L -->|不合格| N[代替表示方法適用]
    N --> M
```

## 5. パフォーマンス最適化フロー

### 5.1 問題読み込み最適化フロー
```mermaid
flowchart TD
    A[問題表示要求] --> B[キャッシュ確認]
    B --> C{キャッシュ存在？}
    C -->|存在| D[キャッシュから表示]
    C -->|不存在| E[DBから問題読み込み]
    E --> F[画像・図表の遅延読み込み]
    F --> G[キャッシュに保存]
    G --> H[画面表示]
    D --> I[表示完了]
    H --> I
    I --> J[次問題のプリロード]
```

### 5.2 大量データ処理フロー
```mermaid
flowchart TD
    A[大量データ処理要求] --> B[処理量推定]
    B --> C{重い処理？}
    C -->|軽い| D[同期処理実行]
    C -->|重い| E[ローディング表示]
    E --> F[バックグラウンド処理開始]
    F --> G[進捗状況更新]
    G --> H{処理完了？}
    H -->|継続中| I[進捗表示更新]
    H -->|完了| J[結果表示]
    I --> G
    D --> K[即座に結果表示]
```

## 6. ユーザビリティ考慮点

### 6.1 操作フィードバック設計
- **タップ反応**: 100ms以内の視覚フィードバック
- **処理中表示**: 1秒を超える処理にはローディング表示
- **完了通知**: 重要な操作完了時はトーストやアニメーション
- **エラー通知**: 分かりやすいエラーメッセージと回復手段提示

### 6.2 ナビゲーション設計
- **パンくずリスト**: 深い階層では現在位置を明示
- **戻る機能**: ハードウェア戻るボタンの適切なハンドリング
- **ショートカット**: 頻繁な操作へのクイックアクセス
- **一貫性**: 同様の操作は同じフローで実行

### 6.3 学習継続サポート
- **中断・再開**: いつでも学習を中断・再開可能
- **進捗保存**: 学習途中での強制終了にも対応
- **モチベーション**: 学習継続を促す適切なフィードバック
- **習慣化**: 定期的な学習を促すリマインダー機能

## 7. フロー検証・テスト観点

### 7.1 ユーザビリティテスト項目
- **タスク完了率**: 主要フローを90%以上のユーザーが完了可能
- **エラー回復**: エラー発生後の回復手順の理解度
- **学習効果**: フローが学習効果を阻害していないか
- **操作時間**: 各操作の所要時間が許容範囲内か

### 7.2 パフォーマンステスト項目
- **応答時間**: 各画面遷移が2秒以内
- **メモリ使用量**: 長時間利用時のメモリリーク検証
- **電池消費**: 学習セッション中の適切な消費量
- **データ使用量**: オフライン前提のため最小限

---

## 更新履歴

| 日付 | バージョン | 変更内容 | 更新者 |
|---|---|---|---|
| 2025-01-27 | 1.0 | 初版作成 | - |

---

**このユーザーフローは、実際のユーザーテストの結果に基づいて継続的に改善していきます。特に学習効果とユーザビリティのバランスを重視します。**